<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulation Configuration</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="static/styles.css">
</head>
<body>
    <div class="container">
        <h1>Simulation Configuration</h1>
        <form id="configForm">
            <label for="configText">Config:</label>
            <textarea id="configText" name="configText" rows="10">{
    "ensemble_members": 1,
    "noise_amplitude": 0.05,
    "simulation_length": 4,
    "weather_event": {
        "properties": {
            "name": "Globe",
            "start_time": "2023-07-15 00:00:00",
            "initial_condition_source": "cds"
        },
        "domains": [
            {
                "name": "global",
                "type": "Window",
                "diagnostics": [{"type": "raw", "channels": ["t2m", "u10m", "v10m"]}]
            }
        ]
    },
    "output_path": "outputs/01_ensemble_notebook",
    "output_frequency": 1,
    "weather_model": "fcnv2_sm",
    "seed": 12345,
    "use_cuda_graphs": false,
    "ensemble_batch_size": 1,
    "autocast_fp16": false,
    "perturbation_strategy": "correlated",
    "noise_reddening": 2.0
}</textarea>

            <label for="regionSelect">Select Region:</label>
            <select id="regionSelect" name="regionSelect">
                <option value="global">Global</option>
                <option value="germany-only">Germany Only</option>
                <option value="custom">Custom</option>
            </select>

            <div id="customRegionDiv" style="display: none;">
                <label for="longitudeInput">Longitude:</label>
                <input type="text" id="longitudeInput" name="longitudeInput" placeholder="Enter longitude">

                <label for="latitudeInput">Latitude:</label>
                <input type="text" id="latitudeInput" name="latitudeInput" placeholder="Enter latitude">

                <label for="regionSizeInput">Region Size (degrees):</label>
                <input type="number" id="regionSizeInput" name="regionSizeInput" placeholder="Enter region size" min="0.1" step="5" value="10">
            </div>

            <label>
                <input type="checkbox" id="skipInference" name="skipInference" checked>
                Skip Inference
            </label>

            <button type="submit">Start Simulation</button>
        </form>
    </div>

    <script>
        $(document).ready(function(){
            $('#regionSelect').on('change', function() {
                if ($(this).val() === 'custom') {
                    $('#customRegionDiv').show();
                } else {
                    $('#customRegionDiv').hide();
                }
            });

            $('#configForm').submit(function(event){
                event.preventDefault();
                const configText = $('#configText').val();
                const regionSelect = $('#regionSelect').val();
                const skipInference = $('#skipInference').is(':checked');
                let longitude = null;
                let latitude = null;
                let regionSize = null;

                if (regionSelect === 'custom') {
                    longitude = parseFloat($('#longitudeInput').val());
                    latitude = parseFloat($('#latitudeInput').val());
                    regionSize = parseFloat($('#regionSizeInput').val());

                    if (isNaN(longitude) || isNaN(latitude) || isNaN(regionSize)) {
                        alert('Please enter valid values for longitude, latitude and region size.');
                        return;
                    }
                }
                
                const data = {
                configText: configText,
                regionSelect: regionSelect,
                skipInference: skipInference,
                longitude: longitude,
                latitude: latitude,
                regionSize: regionSize
            };

            $.ajax({
            url: '/start_simulation',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function() {
            window.location.href = '/cesium?region=' + regionSelect;
            }
                });
            });
        });
    </script>
</body>
</html>